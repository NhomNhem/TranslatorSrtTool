# file_handling.py
import tkinter as tk
from tkinter import filedialog, messagebox, ttk  # Import ttk here
import os
import subprocess
import threading
import config
import translator
# NO gui import here
import sys # Import sys for resource_path


def resource_path(relative_path):
    """ Get absolute path to resource, works for dev and for PyInstaller """
    try:
        # PyInstaller creates a temp folder and stores path in _MEIPASS
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")

    return os.path.join(base_path, relative_path)

def _read_file_lines(file_path):
    """H√†m h·ªó tr·ª£ ƒë·ªçc d√≤ng t·ª´ file v·ªõi x·ª≠ l√Ω l·ªói."""
    try:
        with open(file_path, "r", encoding="utf-8") as file:
            return file.readlines()
    except Exception as e:
        raise Exception(f"L·ªói khi m·ªü file: {e}")

def _write_file_lines(file_path, lines):
    """H√†m h·ªó tr·ª£ ghi d√≤ng v√†o file v·ªõi x·ª≠ l√Ω l·ªói."""
    try:
        with open(file_path, "w", encoding="utf-8") as file:
            file.writelines(lines)
    except Exception as e:
        raise Exception(f"L·ªói khi ghi file: {e}")

def _apply_color_to_srt_line(line, color):
    """√Åp d·ª•ng m√†u cho d√≤ng SRT."""
    if "-->" not in line and not line.strip().isdigit() and line.strip() != "":
        return f"<font color='{color}'>{line.strip()}</font>\n"
    return line

def _apply_color_to_ass_line(line, color):
    """√Åp d·ª•ng m√†u cho d√≤ng ASS."""
    if "Dialogue:" in line:
        parts = line.split(",", 9)
        if len(parts) > 9:
            parts[9] = parts[9].replace(r"{\\c&H[0-9a-fA-F]+&}", "") # Correct regex for ASS color tag
            parts[9] = f"{{\\c&H{color[1:]}&}}{parts[9].strip()}" # Correct color code format for ASS
            return ",".join(parts)
    return line


def apply_color(file_path, output_path, color, progress_var, file_label, open_button, format_, root):
    """√Åp d·ª•ng m√†u cho file ph·ª• ƒë·ªÅ (kh√¥ng d·ªãch)."""
    try:
        lines = _read_file_lines(file_path)
    except Exception as e:
        messagebox.showerror("L·ªói", str(e))
        file_label.config(text="‚ùå L·ªói", foreground="red")
        return

    final_lines = []
    total_lines = len(lines)
    for i, line in enumerate(lines):
        if format_ == ".srt":
            final_lines.append(_apply_color_to_srt_line(line, color))
        elif format_ == ".ass":
            final_lines.append(_apply_color_to_ass_line(line, color))
        else:
            final_lines.append(line)

        progress_var.set(int((i + 1) / total_lines * 100))
        root.update_idletasks()

    try:
        _write_file_lines(output_path, final_lines)
    except Exception as e:
        messagebox.showerror("L·ªói", str(e))
        file_label.config(text="‚ùå L·ªói", foreground="red")
        return

    file_label.config(text="‚úÖ Ho√†n t·∫•t", foreground="green")
    # C·∫•u h√¨nh n√∫t "M·ªü file"
    open_button.config(state=tk.NORMAL, command=lambda p=output_path:  translator.open_file(p))

def apply_color_to_files(file_paths, file_widgets, file_status, root, selected_format, selected_color, btn_open_folder, translated_files):
    """√Åp d·ª•ng m√†u cho t·∫•t c·∫£ c√°c file ƒë√£ ch·ªçn."""
    if not file_paths:
        tk.messagebox.showwarning("C·∫£nh b√°o", "Vui l√≤ng ch·ªçn file tr∆∞·ªõc.")
        return
    colored_file = []
    for file_path in file_paths:
        base_name, ext = os.path.splitext(file_path)
        output_path = os.path.join(os.path.dirname(file_path),
                                   f"{base_name}_COLORED{selected_format.get()}")

        if file_path in file_widgets:
            file_frame_item = file_widgets[file_path]
            file_item_label = file_status[file_path]
            progress_var = file_frame_item.progress_var
            progress_bar = file_frame_item.progress_bar
            open_button = file_frame_item.open_button
            filename_label = file_frame_item.filename_label
        else:
            progress_var = tk.IntVar()
            file_frame_item = tk.Frame(gui.file_frame.inner_frame, bg=config.FRAME_COLOR)  # Background color to FRAME_COLOR
            file_item_label = ttk.Label(file_frame_item, text=f"üîÑ", foreground="#FFD700", width=8, anchor='center', background=config.FRAME_COLOR, font=config.FONT) # Set background and font
            progress_bar = ttk.Progressbar(file_frame_item, length=150, mode="determinate", variable=progress_var, style="TProgressbar") # Reduced length
            open_button = ttk.Button(file_frame_item, text="üìÇ M·ªü", state=tk.DISABLED, style='TButton') # Keep style
            filename_label = ttk.Label(file_frame_item, text=truncate_filename(os.path.basename(file_path)), foreground=config.LABEL_COLOR,
                                        wraplength=180, anchor='w', background=config.FRAME_COLOR, font=config.FONT) # Reduced wraplength, set background and font

            file_status[file_path] = file_item_label
            file_widgets[file_path] = file_frame_item
            file_frame_item.progress_var = progress_var
            file_frame_item.progress_bar = progress_bar
            file_frame_item.open_button = open_button
            file_frame_item.filename_label = filename_label
            #---- Grid layout for file items ----
            file_item_label.grid(row=0, column=0, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            progress_bar.grid(row=0, column=1, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            open_button.grid(row=0, column=2, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            filename_label.grid(row=0, column=3, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            file_frame_item.grid(sticky="ew", pady=2, padx=5, ipadx=2, ipady=1) # Adjusted padding and sticky for frame
            file_frame_item.columnconfigure(1, weight=1) # Progress bar column expands

        # ƒê·∫∑t l·∫°i tr·∫°ng th√°i v√† progress bar
        file_item_label.config(text=f"üîÑ", foreground="#FFD700")  # Ch·ªâ hi·ªÉn th·ªã icon
        progress_var.set(0)
        open_button.config(state=tk.DISABLED, command=None)  # Reset n√∫t m·ªü file

        # √Åp d·ª•ng m√†u (trong thread ri√™ng)
        threading.Thread(target=apply_color, args=(
            file_path, output_path, selected_color.get(), progress_var, file_item_label, open_button, selected_format.get(), root),
                         daemon=True).start()
        colored_file.append(output_path)

    if colored_file:
      translated_files[:] = colored_file # C·∫≠p nh·∫≠t l·∫°i translated_files
      messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ √°p d·ª•ng m√†u cho c√°c file ƒë√£ ch·ªçn.")
      btn_open_folder.config(state=tk.NORMAL, command=lambda: subprocess.Popen(
            ["explorer", os.path.dirname(colored_file[0])] if os.name == 'nt' else ["open", os.path.dirname(
                colored_file[0])]))
    else:
      messagebox.showinfo("Th√¥ng B√°o", "Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªânh s·ª≠a")

def start_translation(file_paths, file_frame, file_status, file_widgets, selected_format, selected_color, root,
                      stop_translation, paused, pause_event, translated_files):
    """Function to initiate and manage the subtitle translation process.""" #Docstring in English for consistency
    if not file_paths:
        tk.messagebox.showwarning("L·ªói", "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file.")
        return

    stop_translation = False
    paused = False
    translated_files.clear()

    # IMPORTANT: Clear existing widgets before adding new ones!
    for widget in file_frame.inner_frame.winfo_children(): # Corrected frame to clear widgets from inner_frame
        widget.destroy()

    for file_path in file_paths:
        # T·∫°o ƒë∆∞·ªùng d·∫´n ƒë·∫ßu ra d·ª±a tr√™n file_path v√† selected_format
        base_name, ext = os.path.splitext(file_path)
        output_path = os.path.join(os.path.dirname(file_path), f"{os.path.basename(base_name)}_VI{selected_format.get()}")

        progress_var = tk.IntVar() # T·∫°o bi·∫øn l∆∞u gi√° tr·ªã thanh ti·∫øn tr√¨nh

        # T·∫°o m·ªôt frame con trong file_frame ƒë·ªÉ nh√≥m c√°c widget cho file n√†y
        file_frame_item = tk.Frame(file_frame.inner_frame, bg=config.FRAME_COLOR)  # Background color to FRAME_COLOR
        file_item_label = ttk.Label(file_frame_item, text=f"üîÑ", foreground="#FFD700", width=8, anchor='center', background=config.FRAME_COLOR, font=config.FONT) # Set background and font
        progress_bar = ttk.Progressbar(file_frame_item, length=150, mode="determinate", variable=progress_var, style="TProgressbar") # Reduced length
        open_button = ttk.Button(file_frame_item, text="üìÇ M·ªü", state=tk.DISABLED, style='TButton')
        filename_label = ttk.Label(file_frame_item, text=truncate_filename(os.path.basename(file_path)), foreground=config.LABEL_COLOR,
                                       wraplength=180, anchor='w', background=config.FRAME_COLOR, font=config.FONT) # Reduced wraplength, set background and font

        file_status[file_path] = file_item_label
        file_widgets[file_path] = file_frame_item

        # Th√™m c√°c thu·ªôc t√≠nh t√πy ch·ªânh v√† frame con
        file_frame_item.progress_var = progress_var
        file_frame_item.progress_bar = progress_bar
        file_frame_item.open_button = open_button
        file_frame_item.filename_label = filename_label

        #---- Grid layout for file items ----
        file_item_label.grid(row=0, column=0, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
        progress_bar.grid(row=0, column=1, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
        open_button.grid(row=0, column=2, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
        filename_label.grid(row=0, column=3, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
        file_frame_item.grid(sticky="ew", pady=2, padx=5, ipadx=2, ipady=1) # Adjusted padding and sticky for frame
        file_frame_item.columnconfigure(1, weight=1) # Progress bar column expands


        # ƒê·∫∑t l·∫°i tr·∫°ng th√°i v√† progress bar
        file_item_label.config(text=f"üîÑ", foreground="#FFD700")  # Ch·ªâ hi·ªÉn th·ªã icon
        progress_var.set(0)
        open_button.config(state=tk.DISABLED, command=None)  # Reset n√∫t m·ªü file

        # B·∫Øt ƒë·∫ßu d·ªãch (trong thread ri√™ng)
        threading.Thread(target=lambda : _start_translate_thread( # S·ª≠ d·ª•ng lambda ƒë·ªÉ truy·ªÅn th√™m arguments
            file_path, output_path, selected_format.get(), selected_color.get(), progress_var, file_item_label,
            open_button, stop_translation, paused, pause_event, root
        ), daemon=True).start() # Pass selected_color.get() and root


def _start_translate_thread(file_path, output_path, format_, color, progress_var, file_item_label, open_button,
                       stop_translation, paused, pause_event, root): # H√†m h·ªó tr·ª£ m·ªõi ƒë·ªÉ x·ª≠ l√Ω thread d·ªãch

    try:
        lines = _read_file_lines(file_path) # ƒê·ªçc file ·ªü file_handling
    except Exception as e:
        messagebox.showerror("L·ªói", str(e))
        file_item_label.config(text="‚ùå L·ªói m·ªü file", foreground="red")
        return

    try:
        translated_lines = translator.translate_subtitle(lines, output_path, format_, color, progress_var, file_item_label, open_button, # G·ªçi h√†m d·ªãch ·ªü translator, truy·ªÅn lines v√†o
                           stop_translation, paused, pause_event, root)
    except Exception as e: # B·∫Øt l·ªói n·∫øu c√≥ l·ªói trong qu√° tr√¨nh d·ªãch
        file_item_label.config(text="‚ùå L·ªói d·ªãch", foreground="red")
        messagebox.showerror("L·ªói", "ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh d·ªãch.") # Th√¥ng b√°o l·ªói chung
        return

    if translated_lines: # Ch·ªâ ghi file n·∫øu c√≥ k·∫øt qu·∫£ d·ªãch
        try:
            _write_file_lines(output_path, translated_lines) # Ghi file ·ªü file_handling
            file_item_label.config(text="‚úÖ Ho√†n t·∫•t", foreground="green")
            open_button.config(state=tk.NORMAL, command=lambda p=output_path:  translator.open_file(p)) # M·ªü file d√πng translator.open_file
        except Exception as e:
            file_item_label.config(text="‚ùå L·ªói ghi file", foreground="red")
            messagebox.showerror("L·ªói", str(e))
            return
    else: # Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ d√≤ng n√†o ƒë∆∞·ª£c d·ªãch (v√≠ d·ª• file r·ªóng, ho·∫∑c l·ªói d·ªãch ·ªü translator)
        file_item_label.config(text="‚ùå L·ªói d·ªãch", foreground="red") # ho·∫∑c "‚ùå File r·ªóng" t√πy logic
        messagebox.showerror("L·ªói", "Kh√¥ng c√≥ n·ªôi dung n√†o ƒë∆∞·ª£c d·ªãch.") # Ho·∫∑c th√¥ng b√°o ph√π h·ª£p

def select_files(file_label, btn_translate, btn_apply_color, file_frame, file_paths, file_status, file_widgets):
    """Ch·ªçn file SRT/ASS."""
    global current_file_path  # S·ª≠ d·ª•ng bi·∫øn global # Consider removing global

    file_paths_temp = filedialog.askopenfilenames(filetypes=[["Subtitle files", "*.srt *.ass"]])
    if file_paths_temp:
        file_paths.clear()  # X√≥a danh s√°ch c≈©
        file_paths.extend(file_paths_temp)  # Th√™m file m·ªõi
        file_label.config(text=f"üìÇ {len(file_paths)} file ƒë√£ ch·ªçn")
        btn_translate.config(state=tk.NORMAL)
        btn_apply_color.config(state=tk.NORMAL)
        current_file_path = file_paths[0]  # Ch·ªâ g√°n file ƒë·∫ßu ti√™n # Consider removing

    else:  # Ng∆∞·ªùi d√πng nh·∫•n Cancel
        file_label.config(text="Ch∆∞a ch·ªçn file", foreground=config.LABEL_COLOR) # Set foreground here too
        btn_translate.config(state=tk.DISABLED)
        btn_apply_color.config(state=tk.DISABLED)
        current_file_path = None  # Reset bi·∫øn # Consider removing
        file_paths.clear() # X√≥a c√°c file ƒë√£ ch·ªçn

    # X√≥a c√°c widget hi·ªÉn th·ªã file c≈©
    for widget in file_frame.inner_frame.winfo_children(): # Clear widgets from inner_frame
        widget.destroy()

    # T·∫°o widget m·ªõi cho c√°c file ƒë√£ ch·ªçn
    if file_paths: # Ch·ªâ th·ª±c hi·ªán n·∫øu c√≥ file
        for i, file_path in enumerate(file_paths):
            progress_var = tk.IntVar()
            file_frame_item = tk.Frame(file_frame.inner_frame, bg=config.FRAME_COLOR) # Background color to FRAME_COLOR
            file_item_label = ttk.Label(file_frame_item, text=f"üîÑ", foreground="#FFD700", width=8, anchor='center', background=config.FRAME_COLOR, font=config.FONT) # Set background, font and anchor
            progress_bar = ttk.Progressbar(file_frame_item, length=150, mode="determinate", variable=progress_var, style="TProgressbar") # Reduced length
            open_button = ttk.Button(file_frame_item, text="üìÇ M·ªü", style='TButton', state=tk.DISABLED)
            filename_label = ttk.Label(file_frame_item, text=truncate_filename(os.path.basename(file_path)), foreground=config.LABEL_COLOR, wraplength=180, anchor='w', background=config.FRAME_COLOR, font=config.FONT) # Reduced wraplength, set background and font

            file_status[file_path] = file_item_label
            file_widgets[file_path] = file_frame_item
            file_frame_item.progress_var = progress_var  # L∆∞u tr·ªØ c√°c ƒë·ªëi t∆∞·ª£ng
            file_frame_item.progress_bar = progress_bar
            file_frame_item.open_button = open_button
            file_frame_item.filename_label = filename_label


            #---- Grid layout for file items ----
            file_item_label.grid(row=0, column=0, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            progress_bar.grid(row=0, column=1, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            open_button.grid(row=0, column=2, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            filename_label.grid(row=0, column=3, padx=(0,5), pady=2, sticky="ew") # Adjusted padx
            file_frame_item.grid(sticky="ew", pady=2, padx=5, ipadx=2, ipady=1) # Adjusted padding and sticky for frame
            file_frame_item.columnconfigure(1, weight=1) # Progress bar column expands


def open_translated_folder(translated_files):
    """M·ªü th∆∞ m·ª•c ch·ª©a c√°c file ƒë√£ d·ªãch/ƒë·ªïi m√†u."""
    if translated_files:
        # M·ªü th∆∞ m·ª•c c·ªßa file ƒë·∫ßu ti√™n trong danh s√°ch
        subprocess.Popen(["explorer", os.path.dirname(translated_files[0])] if os.name == 'nt' else ["open", os.path.dirname(translated_files[0])])

def cancel_translation(stop_translation):
    """Cancels the translation process."""
    # Use messagebox for confirmation
    if messagebox.askyesno("X√°c nh·∫≠n", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy?"):
        stop_translation = True
        # You might want to add more cleanup here, depending on # Consider cleanup actions
        # what needs to be reset if the translation is cancelled mid-process.
def truncate_filename(filename, max_length=config.FILE_NAME_MAX_LENGTH):
    if len(filename) > max_length:
        return filename[:max_length - 3] + "..."
    return filename